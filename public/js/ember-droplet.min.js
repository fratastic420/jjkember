/*! ember-droplet by Adam Timberlake created on 2014-04-22 */
!function(a,b,c){"use strict";a.DropletController=b.Mixin.create({mimeTypes:["image/jpeg","image/jpg","image/gif","image/png","text/plain"],extensions:["jpeg","jpg","gif","png"],requestHeaders:{},postData:{},files:[],uploadStatus:{uploading:!1,percentComplete:0,error:!1},init:function(){b.set(this,"files",[]),this._super()},actions:{addValidFile:function(a){return this._addFile(a,!0)},addInvalidFile:function(a){return this._addFile(a,!1)},deleteFile:function(a){return b.set(a,"deleted",!0),a},clearAllFiles:function(){b.set(this,"files",[])},uploadAllFiles:function(){if(0===b.get(this,"validFiles").length)return!1;var d=b.get(this,"dropletUrl"),e=new c.Deferred,f=this.get("postData"),g=this.get("requestHeaders");b.set(this,"uploadStatus.uploading",!0),b.set(this,"uploadStatus.error",!1),b.assert("You must specify the `dropletUrl` parameter in order to upload files.",!!d);var h=new a.XMLHttpRequest;h.open("post",d,!0);var i=new a.FormData,j=b.get(this,"useArray",!0)?"file[]":"file";b.EnumerableUtils.forEach(b.get(this,"validFiles"),function(a){i.append(j,a.file)},this);for(var k in f)f.hasOwnProperty(k)&&i.append(k,f[k]);this._addProgressListener(h.upload),this._addSuccessListener(h.upload,e),this._addErrorListener(h.upload,e),h.onreadystatechange=function(){if(4===h.readyState){var c=a.JSON.parse(h.responseText);e.resolve(c),b.tryInvoke(this,"didUploadFiles",[c])}}.bind(this),h.setRequestHeader("X-File-Size",this._getSize());for(k in g)(g.hasOwnProperty(k)||k in g)&&h.setRequestHeader(k,g[k]);return h.send(i),e.promise()}},validFiles:b.computed(function(){return this._filesByProperties({valid:!0,deleted:!1,uploaded:!1})}).property("files.length","files.@each.deleted","files.@each.uploaded"),invalidFiles:b.computed(function(){return this._filesByProperties({valid:!1})}).property("files.length","files.@each.deleted"),uploadedFiles:b.computed(function(){return this._filesByProperties({uploaded:!0})}).property("files.length","files.@each.uploaded"),deletedFiles:b.computed(function(){return this._filesByProperties({deleted:!0})}).property("files.length","files.@each.deleted"),_filesByProperties:function(a){return b.get(this,"files").filter(function(b){for(var c in a)if((a.hasOwnProperty(c)||c in a)&&b[c]!==a[c])return!1;return!0})},_getSize:function(){var a=0;return b.EnumerableUtils.forEach(b.get(this,"validFiles"),function(b){a+=b.file.size}),a},_addSuccessListener:function(a){a.addEventListener("load",function(){b.EnumerableUtils.forEach(b.get(this,"validFiles"),function(a){b.set(a,"uploaded",!0)}),b.set(this,"uploadStatus.uploading",!1)}.bind(this),!1)},_addErrorListener:function(a,c){a.addEventListener("error",function(){b.set(this,"uploadStatus.uploading",!1),b.set(this,"uploadStatus.error",!0),c&&c.reject()}.bind(this))},_addProgressListener:function(a){a.addEventListener("progress",function(a){if(a.lengthComputable){var c=a.loaded/this._getSize()*100;b.set(this,"uploadStatus.percentComplete",Math.round(c))}}.bind(this),!1)},_addFile:function(a,c){var d="extension-%@".fmt(a.name.match(/\.(.+)$/i)[1]).toLowerCase(),e={file:a,valid:c,uploaded:!1,deleted:!1,className:d};return b.get(this,"files").pushObject(e),e}})}(window,window.Ember,window.jQuery),function(a,b){"use strict";a.DropletView=b.View.extend({classNames:["droppable"],ImagePreview:b.View.extend({tagName:"img",attributeBindings:["src"],src:null,image:null,didInsertElement:function(){var c=new a.FileReader,d=b.get(this,"image.file");return d.type.match(/^image\//i)?(c.onload=function(a){this.get("isDestroyed")!==!0&&b.set(this,"src",a.target.result)}.bind(this),void c.readAsDataURL(d)):void this.destroy()}}),MultipleInput:b.View.extend({tagName:"input",classNames:"files",attributeBindings:["type","multiple"],type:"file",multiple:"multiple",change:function(){var a=this.get("element").files;return this.get("parentView").traverseFiles(a)}}),drop:function(a,b){return this._preventDefaultBehaviour(a),this.traverseFiles(a.dataTransfer.files||b)},traverseFiles:function(a){var c=b.get(this,"controller"),d=b.get(c,"mimeTypes"),e=b.get(c,"extensions");b.assert("`mimeTypes` is undefined. Does your controller implement the `$emberDropletController` mixin?",!!d),b.assert("`mimeTypes` is not an array. It should be an array of valid MIME types.",!!b.isArray(d));for(var f=0,g=a.length;g>f;f++)if(a.hasOwnProperty(f)||f in a){var h=a[f],i=h.name.split(".").pop();-1!==$.inArray(h.type,d)||-1!==$.inArray(i,e)?c.send("addValidFile",h):c.send("addInvalidFile",h)}return!0},_preventDefaultBehaviour:function(a){a.preventDefault(),a.stopPropagation()},dragOver:function(a){this._preventDefaultBehaviour(a)},dragEnter:function(a){this._preventDefaultBehaviour(a)},dragLeave:function(a){this._preventDefaultBehaviour(a)}})}(window,window.Ember);